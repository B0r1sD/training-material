---
layout: tutorial_hands_on
title: Finding muon stopping sites using the AIRSS and UEP methods
level: Introductory
zenodo_link: https://zenodo.org/record/6344385
questions:
- "What are stopping sites and why is finding them important?"
- "What computational techniques can be used to find stopping sites?"
- "What materials can I apply these techniques to?"
- "How can Galaxy help me with my analysis?"
objectives:
- "Understand why finding stopping sites is useful"
- "Apply the AIRSS and UEP methods together to find stopping sites"
- "Understand the limitations of these tools and techniques"
time_estimation: 1H
key_points:
- Galaxy supports multiple PyMuonSuite tools which can be used together to find muon stopping sites
- The AIRSS method involves three stages - site generation, optimisation, and clustering
- There are multiple approaches for the optimisation stage; the UEP method can be performed via Galaxy, or CASTEP can be used externally
- The UEP approach requires a CASTEP DFT calculation to be completed as a starting point
contributions:
  authorship:
    - elichad
    - leandro-liborio
    - patrick-austin
  editing:
    - joelvdavies
subtopic: muon-spectroscopy
priority: 2
abbreviations:
  AIRSS: Ab Initio Random Structure Search
  DFT: Density Functional Theory
  UEP: Unperturbed Electrostatic Potential
---


# Introduction

The problem of identifying the stopping site of a muon is often key in the
interpretation of experimental results, and also one of those that computational
tools are most commonly used to solve. Roughly, one can imagine that at the
atomic level, muon spectroscopy experiments go something like this:

- The polarized muon beam is fired at the sample, and the muons travel a certain
  depth inside the target
- Through inelastic collisions with the atoms of the lattice, muons shed their
  kinetic energy, which turns into heat or causes small amounts of damage to the
  crystal. This continues until the muons' kinetic energy becomes low enough
  that it is comparable to their potential energy in the electrostatic fields
  generated by electrons and nuclei alike.
- At that point, Coulomb forces start driving the muon, and eventually, it loses
  as much energy as possible and comes to a stop in a position that represents a
  local (and possibly global) minimum for its electrostatic potential energy,
  where it spends the rest of its time until it decays.

![Graphical illustration of muons being implanted in a sample, then decaying to a positron and being detected](../../images/muon_spectroscopy_diagram.png)

Where these minima of the potential actually are isn't always obvious. In some
cases it's trivial, for example in organic molecules the mechanism is often the
same as for regular hydrogenation. The muon, having captured an electron and
formed a muonium pseudo-atom, ends up breaking a double or triple bond and
attaching itself to the molecule by using one of the unpaired electrons. However
in other, crystalline structures it can be a lot harder. While an atomistic
simulation that accurately predicts the potential through which the atoms
interact can be used to identify possible sites, this approach is not fully
reliable (for example when applied to fluorides) {% cite Liborio2018 %}. In
order to avoid such limitations, one can use a brute force approach to explore
all the possible positions in which the muon may end up. {AIRSS} is one such
method {% cite Liborio2018 %}.

In this workflow, we use the {UEP} Method: a method that requires only a single
{DFT} calculation, which is used to compute the electronic density of the host
material {% cite Sturniolo2020 %}. This, in turn, is used to calculate the
minima of the host material’s electrostatic potential and to estimate the
stopping site of the diamagnetic muon, relying on the approximation that the
muon’s presence does not significantly affect its surroundings.



> ### Agenda
>
> In this tutorial, we will cover:
>
> 1. TOC
> {:toc}
>
{: .agenda}

# Preparation steps
First, we need to download some simple example data and a workflow for finding
possible stopping sites. For this, we use a CASTEP `.cell` file containing two
Silicon atoms. In order to run this workflow, we also need the output files from
calculating the electronic density with CASTEP and a parameter file for our tools.
These have all been pre-generated for this tutorial, but in general you would
need to create these yourself outside of Galaxy.

## Get data

> <hands-on-title>Data upload</hands-on-title>
>
> 1. Create a new history for this tutorial
> 2. Import the files from [Zenodo]({{ page.zenodo_link }}) or from
>    the shared data library (`GTN - Material` -> `{{ page.topic_name }}`
>     -> `{{ page.title }}`):
>
>    ```
>    https://zenodo.org/record/6344385/files/Si.cell
>    https://zenodo.org/record/6344385/files/Si.castep
>    https://zenodo.org/record/6344385/files/Si.den_fmt
>    ```
>
>    {% snippet faqs/galaxy/datasets_import_via_link.md %}
>
>    {% snippet faqs/galaxy/datasets_import_from_data_library.md %}
>
> 3. Rename the datasets to match their file names, if needed.
> 4. Check that the datatype is correct for each dataset.
>
>    {% snippet faqs/galaxy/datasets_change_datatype.md datatype="datatypes" %}
>
{: .hands_on}

## Import workflow

> <hands-on-title>Import workflow</hands-on-title>
>
> 1. Import the workflow for this tutorial using [these instructions](workflows/).
> 2. Open the editor for the workflow, and verify that all the required tools
>    are installed on your Galaxy instance, and have the same version(s) as the
>    tools in workflow. If this is not the case a dialogue box will warn you.
>
{: .hands_on}
# Finding stopping sites

We can execute the entire workflow in one go, which will generate stopping sites
based on our three input files. Alternatively, the four tools that comprise the
workflow can be run one by one, or included in other workflows. To aid
understanding, the steps below describe each one in detail: what parameters they
take and what exactly they do.

## AIRSS Stage 1: Create configuration file

The first tool in the workflow handles all the configuration of the subsequent
tools in one go. When used outside a workflow, it provides a UI with default
values and help for the possible parameters used by the various PyMuonSuite
operations {% cite Sturniolo_pymuon-suite_2022 %}. For this example many of these are either left to their default
values or are not specifically relevant to the {AIRSS} use case. Those that are
important have some further explanation.

> <hands-on-title>Tool details</hands-on-title>
>
> 1. {% tool [PyMuonSuite AIRSS Configure](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_yaml_config/pm_yaml_config/0.2.1+galaxy0) %} with the following parameters:
>    - *"General Parameters"*:
>      - *"Poisson radius"*: `0.8` Sets the minimum spacing between generated muons
>      - *"Name"*: `si` Name for this simulation
>      - *"Charged muon"*: `true` Treat the muon as a positive charge
>      - *"Geometry optimization steps"*: `300` Maximum number of geometry optimisation steps
>      - *"Van der Waals scale"*: `0.25` Sets the minimum spacing between generated muons and existing atoms
>      - *"Output folder name"*: `muon-airss-out` Name to call the output folder, only relevant when using the zipped intermediary outputs of the tools
>      - *"Geometry optimization tolerance"*: `0.02` Tolerance on geometry optimisation in eV/AA
>    - *"Calculator parameters"*:
>      - *"Optimization calculator"*: `UEP` Method to use for optimisation
>      - *"Gaussian width factor"*: `4.0` Adjusts how atom potentials are modelled
>    - *"Clustering Parameters"*:
>      - *"Clustering method"*: `hierarchical` Perform hierarchical clustering (other option is k-means)
>      - *"t parameter for hierarchical clustering"*: `0.2` Threshold value for clusters
>      - *"Supercell"*: `1` Supercell size and shape to use
>      - *"K-points grid"*: `[1,1,1]` List of three integer k-points
>      - *"Max SCC steps"*: `200` If applicable, max number of SCC steps to perform
> 2. Should generate the following output(s):
>    - {% icon param-file %} `Configuration for si` (Output dataset)
>
>    > <comment-title>Optimization calculator</comment-title>
>    >
>    > Here we chose {UEP} as our method for the optimisation (step 3), as
>    > described earlier. The other alternatives are CASTEP and DFTB+ Each
>    > calculator will have different settings associated with it. DFTB+ has a 
>    > corresponding tool, {% tool [PyMuonSuite AIRSS DFTB+ Optimise](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_dftb_opt/pm_dftb_opt/0.1.1) %}
>    > that could be used for stage 3, however CASTEP does not. Instead,
>    > if we had used CASTEP we would have to manually run CASTEP on these
>    > structures outside of Galaxy, then zip and upload the results to use as
>    > the input to step 4.
>    {: .comment}
>
>    > <comment-title>Clustering method</comment-title>
>    >
>    > The choice here is between `hierarchical` and `k-means`. `hierarchical`
>    > clustering builds a tree branching progressively from a single "trunk"
>    > containing all the stopping sites to multiple "leaves" of each individual
>    > site. The number of clusters is determined by the t parameter: `0`
>    > corresponds to individual sites, with the number of clusters decreasing
>    > as t increases towards `1`. `k-means` attempts to create clusters which
>    > have equal variance within them. In this case the number of clusters to
>    > (attempt to) form is the available parameter.
>    {: .comment}
>
{: .hands_on}

The output of this tool is a simple text file containing all the parameters we
set, formatted for PyMuonSuite. As an alternative to running this step, an
existing configuration file (either from an earlier use of the tool or uploaded
directly) can be used as the input for the other PyMuonSuite tools.

## AIRSS Stage 2: Generate muonated structures

First, we must randomly generate a batch of possible locations for the muon
using the {AIRSS} method using the following parameters.

> <hands-on-title>Tool details</hands-on-title>
>
> 1. {% tool [PyMuonSuite AIRSS Generate](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_muairss_write/pm_muairss_write/0.2.1+galaxy1) %} with the following parameters:
>    - {% icon param-file %} *"Structure file"*: `Si.cell` (Input dataset)
>    - {% icon param-file %} *"YAML parameter file"*: `Configuration for si` (Input dataset)
>    - *"Does your configuration use the CASTEP calculator?"*: `No`
> 2. Should generate the following output(s):
>    - {% icon param-file %} `Muonated Si.cell using Configuration for si` (Output dataset)
>
>    > <comment-title>CASTEP calculator</comment-title>
>    >
>    > In our example we have not used the CASTEP calculator. If we had, we
>    > would have the option of providing a CASTEP parameter file as well.
>    > This file would be included in the output which, as described earlier,
>    > would need to be run outside of Galaxy instead of following step 3.
>    {: .comment}
>
{: .hands_on}

The output of this tool is a zipped folder containing muon positions. We can
then use this with the next tool in our workflow.

## AIRSS Stage 3: Optimisation using UEP

Now we have some muonated structures, we have to optimise the position of the
muon in each. This tool minimises the classical electrostatic forces with
respect to the muon position, using the {UEP} generated for the original
structure.

> <hands-on-title>Task description</hands-on-title>
>
> 1. {% tool [PyMuonSuite AIRSS UEP Optimise](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_uep_opt/pm_uep_opt/0.2.1+galaxy1) %} with the following parameters:
>    - {% icon param-file %} *"Muonated structures (.zip)"*: `Muonated Si.cell using Configuration for si` (output of **PyMuonSuite AIRSS Generate** {% icon tool %})
>    - {% icon param-file %} *"Charge density file (.den_fmt)"*: `Si.den_fmt` (Input dataset)
>    - {% icon param-file %} *"CASTEP log (.castep)"*: `Si.castep` (Input dataset)
> 2. Should generate the following output(s):
>    - {% icon param-file %} `UEP results for Muonated Si.cell using Configuration for si` (Output dataset)
>
{: .hands_on}

The output of this tool is a zipped folder containing the optimised structures.
We can then use this with the next tool in our workflow.

## AIRSS Stage 4: Clustering

Finally, we can cluster the optimised positions in order to generate a short
list of potential stopping sites.

> <hands-on-title>Task description</hands-on-title>
>
> 1. {% tool [PyMuonSuite AIRSS Cluster](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_muairss_read/pm_muairss_read/0.2.1+galaxy1) %} with the following parameters:
>    - {% icon param-file %} *"optimised muonated structures (.zip)"*: `UEP results for Muonated Si.cell using Configuration for si` (output of **PyMuonSuite AIRSS UEP Optimise** {% icon tool %})
> 2. Should generate the following output(s):
>    - {% icon param-file %} `Cluster Report` (Output dataset)
>    - {% icon param-file %} `Cluster Data` (Output dataset)
>
{: .hands_on}

The `Cluster report` will contain a human readable summary of the clustering,
with the underlying raw data also provided.

> <details-title>`Cluster report` header and settings</details-title>
>
> ```
> ****************************
> |                          |
> |       PYMUON-SUITE       |
> |  MuAirss Clusters report |
> |                          |
> ****************************
> 
> Name: si
> Date: 2023-01-09 17:16:54.379024
> Structure file(s): input_structure.cell
> Parameter file: params.yaml
> 
> Clustering method: Hierarchical
>     t = 0.2
> 
> *******************
> ```
> 
> The top of the report contains a summary of the settings used to run the
> clustering, and when it was run.
>
{: .details}

> <details-title>`Cluster report` content</details-title>
>
> ```
> Clusters for si:
> CALCULATOR: uep
> 	2 clusters found
> 
> 
> 	-----------
> 	Cluster 1
> 	-----------
> 	Structures: 39
> 
> 	Energy (eV):
> 	Minimum		Average		StDev
> 	-8.61		-8.61		0.00
> 
> 	Minimum energy structure: si_28
> 
> 
> 	Structure list:
> 	si_1	si_2	si_3	si_4	
> 	si_5	si_7	si_8	si_10	
> 	si_11	si_12	si_14	si_15	
> 	si_16	si_17	si_19	si_20	
> 	si_21	si_22	si_23	si_25	
> 	si_26	si_27	si_28	si_29	
> 	si_30	si_31	si_32	si_33	
> 	si_34	si_35	si_36	si_37	
> 	si_38	si_39	si_40	si_41	
> 	si_42	si_43	si_45	
> 
> 	-----------
> 	Cluster 2
> 	-----------
> 	Structures: 7
> 
> 	Energy (eV):
> 	Minimum		Average		StDev
> 	-8.52		-8.52		0.00
> 
> 	Minimum energy structure: si_18
> 
> 
> 	Structure list:
> 	si_6	si_9	si_13	si_18	
> 	si_24	si_44	si_46	
> 
> 	----------
> 
> 	Similarity (ranked):
> 	1 <--> 2 (distance = 0.225)
> 
> --------------------------
> 
> 
> ==========================
> ```
> 
> The remainder of the report details the clusters (each of which represents a
> stopping site) that the individual muonated structures were assigned to. In
> addition to showing the relative numbers at each site, we also report the
> energy corresponding to that site. This can help inform which site(s) are most
> favourable for the muon.
>
{: .details}

While we may have generated tens of random positions, we should now see only a
few potential stopping sites as during the optimisation stage the muons migrated
to minimise the forces acting on them. These new positions are likely to
overlap, corresponding to local energy minima.


The `Cluster data` output contains a machine-readable summary of the stopping
sites, including their location and energy.

# Conclusion

![Graphical illustration of the generation, optimisation and clustering of potential stopping sites](../../images/muon_stopping_sites_diagram.png)

We have used tools from PyMuonSuite to determine possible locations of implanted
muons in a simple structure. In reality, the structure of interest will likely
be more complex, but the workflow will remain the same. It is also possible to
modify the settings used by PyMuonSuite with
{% tool [PyMuonSuite AIRSS Configure](toolshed.g2.bx.psu.edu/repos/muon-spectroscopy-computational-project/pm_yaml_config/pm_yaml_config/0.2.1+galaxy0) %}
and then use that file in our input, or alternatively modify the workflow to
include this tool directly. The Galaxy implementation has explanations of the
various settings, and sensible values set by default.
