---
layout: tutorial_slides
logo: assets/images/gat.png

title: "Galaxy and Celery"
contributions:
  authorship:
  - mira-miracoli
  editing:
  - hexylena
subtopic: jobs

---

## Can you eat it?

.pull-left[
Celery is an asynchronous distributed task queue.

It consists of:

- Application that sends tasks
- to a broker with queues
- Workers that execute the tasks
- A Result backend to store the task results

It's written in Python but supports multiple other languages via webhooks.
]

.pull-right[
	![celery logo, a cartoon of a piece of celery](images/celery.png)
]

---

## So many features

.pull-left[
- different worker/process [pool options](https://distributedpython.com/posts/celery-execution-pools-what-is-it-all-about/), depending on your needs â€“ I/O or CPU bound
- CeleryBeat a scheduler for repeated tasks
- Flower, a monitoring interface for
	- Showing tasks, queues and workers
	- Prometheus + Grafana Integration
]

.pull-right[
	![celery logo, a cartoon of a piece of celery, now with the text celery next to it](images/celery-logo.png)
]

---

# How Celery Can Improve Galaxy


---

.pull-left[
**The Problem**

The Galaxy Server should respond quickly to every request.
Without Celery, Gunicorn and the Galaxy handlers have to do many I/O bound side tasks.
For example packing a zip for history export.

**The Solution**

Queue asynchronous tasks with Celery
- on a different node or even a whole cluster

]

.pull-right[
	![galaxy logo next to celery logo, with two purple hearts](images/galaxy+celery.png)
]

---

![A workflow diagram is shown with logos and arrows. Galaxy on the left sends tasks to rabbit MQ. Celery fetches tasks from Rabbit MQ and proceses them. Then celery sends results to the backend database. Finally Galaxy fetches those same results back from the backend.](images/workflow.png)

---

## What is Celery Used For

- Processing upload jobs
- Processing metadata
- Recalculating disk usage
- Purging datasets
- Changing datatypes
- Preparing compressed downloads (histories, etc.)
- Creating PDFs for Galaxy workflow reports
- Cleaning up short term storage
- Preparing history exports
. . .

---

.pull-left [
## What do you need to enable Celery?

- A properly set up broker, for example with [UseGalaxy.eu RabbitMQ Ansible Role](https://github.com/usegalaxy-eu/ansible-rabbitmq)
- A redis server, for example with [geerlingguy's Ansible Role](https://github.com/geerlingguy/ansible-role-redis)
- NFS to which you export galaxy's root dir and which is mounted on the Celery nodes
- Optional: Flower, the Celery UI, for example with [UseGalaxy.eu Flower Ansible Role](https://github.com/usegalaxy-eu/flower-ansible-role) 
]

.pull-right[
![Collection of three logos, Galaxy, RabbitMQ, and celery](images/logos.png)
]

---

.pull-left[
![Celery's green logo](images/celery.img)
]

.pull-right[

## Where to get Celery?

- It is in your Galaxy venv already!
- Mount the Galaxy root with venv and config dirs on your Celery node
- Create an Ansible Playbook with [UseGalaxy.eu's Systemd Role](https://github.com/usegalaxy-eu/ansible-galaxy-systemd)
- For inspiration, you can check out our vars [file](https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/group_vars/celerycluster.yml)
]

---

.pull-left[
![](images/celery.img)
]

.pull-right[

## Where to get Celery?

- It is in your Galaxy venv already!
- Mount the Galaxy root with venv and config dirs on your Celery node
- Create an Ansible Playbook with [UseGalaxy.eu's Systemd Role](https://github.com/usegalaxy-eu/ansible-galaxy-systemd)
- For inspiration, you can check out our vars [file](https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/group_vars/celerycluster.yml)
]

---
.pull-left[
	![screenshot of galaxy documentation page, linked in next section](images/docs.png)
]
.pull-right[
## How to set the Galaxy Config
- [Configuration in `galaxy.yml` file](https://docs.galaxyproject.org/en/latest/admin/options.html#amqp-internal-connection)
- Documentation still WIP
- `celery_broker` can be set, but defaults to `amqp_internal_connection`,
	'where you set the amqp connection string for your Rabbit MQ. That one is also used for Pulsar
- `celery_conf` taskes basically everything that is also [documented](https://docs.celeryq.dev/en/stable/getting-started/first-steps-with-celery.html)
- set your [`result_backend`](https://docs.celeryq.dev/en/stable/getting-started/first-steps-with-celery.html#keeping-results) /redis connection here
- But: Celery, Flower and RabbitMQ are well documented
]

---

.pull-left[
![Screenshots of Galaxy, RabbitMQ, and Flower](images/have.png)
]

.pull-right[

## What's currently easy

- A Galaxy instance
- A RabbitMQ instance
- Running Celery via Gravity
]

---

## To Be Completed

- Securing Celery documentation for Galaxy Admins
- Running Celery on another node, outside of Gravity (maybe.)
- The correct Telegraf configuration for monitoring 
- Dashboards
